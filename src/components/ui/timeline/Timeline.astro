---
interface Item {
  title: string;
  company: string;
  region: string;
  description: string;
  technologies?: string[];
  date?: string;
}

interface Props { items: Item[], icons?: {company: string; location: string }, centered?: boolean }
// fallback icons from assets if not provided via props
// @ts-ignore - vite raw import yields string
import jobIconRaw from '../../../assets/icons/job-title-icon.svg?raw';
// @ts-ignore
import companyIconRaw from '../../../assets/icons/company-icon.svg?raw';
// @ts-ignore
import locationIconRaw from '../../../assets/icons/location-icon.svg?raw';

// apprentice entries linked to work items
import { apprentice } from '../../../data/apprentice';

function normalizeIcon(raw: string): string {
  let s = raw
    .replace(/<\?xml[\s\S]*?\?>/g, '')
    .replace(/<!--([\s\S]*?)-->/g, '')
    .replace(/width=\"[^\"]+\"/g, 'width="16"')
    .replace(/height=\"[^\"]+\"/g, 'height="16"')
    .replace(/stroke=\"#000000\"/g, 'stroke="currentColor"')
    .replace(/fill=\"#000000\"/g, 'fill="none"')
    .replace(/fill=\"#ffffff\"/gi, 'fill="none"');
  // Ensure root svg has fill="none" and stroke="currentColor"
  s = s.replace(/<svg([^>]*)>/, (m, attrs) => {
    let a = attrs;
    if (!/fill=/.test(a)) a += ' fill="none"';
    if (!/stroke=/.test(a)) a += ' stroke="currentColor"';
    return `<svg${a}>`;
  });
  return s;
}

const props = Astro.props as Props;
const companyIcon = (props.icons?.company ?? normalizeIcon(companyIconRaw));
const locationIcon = (props.icons?.location ?? normalizeIcon(locationIconRaw));
const { items, centered = true } = props;
---

{centered ? (
  <div class="relative mx-auto max-w-5xl px-4 md:px-0">
    <!-- Center vertical line -->
    <div class="pointer-events-none absolute inset-y-0 left-1/2 w-px -translate-x-1/2 bg-[var(--border)]"></div>

    <div class="space-y-8 md:space-y-12">
      {items.map((item, index) => {
        const isLeft = index % 2 === 0;
        // match apprentice entries by explicit item.id (if present) otherwise by index
        const itemId = typeof (item as any).id !== 'undefined' ? (item as any).id : index;
        const linkedApprentices = apprentice.filter(a => a.work_id === itemId);
        return (
          <div class:list={[
            // stacked on mobile, alternating row layout on md+
            'relative flex flex-col md:flex-row items-stretch',
            isLeft ? 'md:justify-start' : 'md:justify-end',
          ]}>
            <!-- Dot on the center line (smaller on mobile) -->
            <div class="absolute left-1/2 -translate-x-1/2 top-3 md:top-4 size-2 md:size-3 rounded-full bg-[var(--accent)] ring-3 md:ring-4 ring-[color:var(--background)]"></div>

             <!-- Date on the opposite side (static above on mobile, absolute on md+) -->
            <div class:list={[
              'mt-3 mb-2 flex flex-col md:absolute md:top-4',
              isLeft
                ? 'md:left-1/2 md:translate-x-16 md:-translate-y-2 md:items-start'   // align to start on left side (md+)
                : 'md:right-1/2 md:-translate-x-16 md:-translate-y-2 md:items-end',  // align to end on right side (md+)
            ]}>
              <span class:list={[
                'bg-gradient-to-r from-[var(--accent)] to-[var(--accent-dark)] bg-clip-text text-transparent font-extrabold',
                isLeft ? 'text-left md:text-left' : 'text-left md:text-right'
              ]}>
                {item.date}
              </span>
              {linkedApprentices.length > 0 && (
                <div class="mt-2 space-y-2">
                  {linkedApprentices.map(a => (
                    <div class="card-surface p-3 w-full max-w-[92%] md:w-96 mx-auto md:mx-0 text-sm">   
                      <div class="flex items-center justify-between">
                        <div class="font-semibold text-xs">{a.title}</div>
                        <div class="text-[color:var(--color-text-muted)] text-xs">{a.date}</div>
                      </div>
                      <div class="text-xs text-[color:var(--color-text-muted)] mt-1">{a.company}{a.region ? ` • ${a.region}` : ''}</div>
                      {a.description && <p class="text-[color:var(--color-text-secondary)] text-xs mt-2 m-0">{a.description}</p>}
                      {a.technologies && a.technologies.length > 0 && (
                        <div class="mt-2 flex flex-wrap gap-2">
                          {a.technologies.map((tech) => (
                            <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-medium" style="background: rgba(var(--accent-rgb),0.08); color: var(--accent); border: 1px solid rgba(var(--accent-rgb),0.15);">
                              {tech}
                            </span>
                          ))}
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              )}
            </div>

            <div class:list={[
              'w-full max-w-[92%] mx-auto md:w-1/2 md:mx-0 mt-2 md:mt-0',
              isLeft ? 'md:pr-6 md:pl-0' : 'md:pl-6 md:pr-0',
            ]}>
              <div class="card-surface p-4 md:p-6">
                <div class="mb-2 space-y-1">
                  <h3 class="text-xs leading-snug font-semibold m-0 flex items-center gap-2">
                    {item.title}
                  </h3>
                  <p class="text-sm font-medium text-[color:var(--color-text-muted)] m-0 flex items-center gap-2">
                    <span class="inline-flex" aria-hidden="true" set:html={companyIcon} />
                    {item.company}
                  </p>
                  <p class="text-sm text-[color:var(--color-text-muted)] m-0 flex items-center gap-2">
                    <span class="inline-flex" aria-hidden="true" set:html={locationIcon} />
                    {item.region}
                  </p>
                </div>
                <p class="text-[color:var(--color-text-secondary)] m-0">{item.description}</p>
                {item.technologies && item.technologies.length > 0 && (
                  <div class="mt-3 flex flex-wrap gap-2">
                    {item.technologies.map((tech) => (
                      <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-medium" style="background: rgba(var(--accent-rgb),0.1); color: var(--accent); border: 1px solid rgba(var(--accent-rgb),0.3);">
                        {tech}
                      </span>
                    ))}
                  </div>
                )}
              </div>
            </div>
          </div>
        );
      })}
    </div>
  </div>
) : (
    <div class="relative mx-auto max-w-5xl px-4 md:px-0">
    <!-- Left vertical line -->
    <div class="pointer-events-none absolute inset-y-0 left-0 md:left-5 w-px bg-[var(--border)]"></div>
    <div class="space-y-6 md:space-y-12">
      {items.map((item, index) => {
        const itemId = typeof (item as any).id !== 'undefined' ? (item as any).id : index;
        const linkedApprentices = apprentice.filter(a => a.work_id === itemId);
        return (
        <div class="relative pl-3 md:pl-16">
          <div class="absolute left-0 md:left-5 top-3 md:top-4 size-2 md:size-3 rounded-full bg-[var(--accent)] ring-2 md:ring-4 ring-[color:var(--background)]"></div>
          <div class="card-surface p-4 md:p-6 w-full max-w-[92%] mx-auto md:mx-0 min-w-0">
            <div class="mb-2 space-y-1">
              <h3 class="text-xs leading-snug font-semibold m-0 flex items-center gap-2">
                {item.title}
              </h3>
              <p class="text-sm font-medium text-[color:var(--color-text-muted)] m-0 flex items-center gap-2">
                <span class="inline-flex" aria-hidden="true" set:html={companyIcon} />
                {item.company}
              </p>
              <p class="text-sm text-[color:var(--color-text-muted)] m-0 flex items-center gap-2">
                <span class="inline-flex" aria-hidden="true" set:html={locationIcon} />
                {item.region}
              </p>
            </div>
            <p class="text-[color:var(--color-text-secondary)] m-0">{item.description}</p>
            {item.technologies && item.technologies.length > 0 && (
              <div class="mt-3 flex flex-wrap gap-2">
                {item.technologies.map((tech) => (
                  <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-medium" style="background: rgba(var(--accent-rgb),0.1); color: var(--accent); border: 1px solid rgba(var(--accent-rgb),0.3);">
                    {tech}
                  </span>
                ))}
              </div>
            )}
            {linkedApprentices.length > 0 && (
              <div class="mt-3 space-y-2">
                {linkedApprentices.map(a => (
                  <div class="card-surface p-3 text-sm w-full max-w-[92%] md:w-96 mx-auto md:mx-0">
                    <div class="flex items-center justify-between">
                      <div class="font-semibold text-xs">{a.title}</div>
                      <div class="text-xs text-[color:var(--color-text-muted)]">{a.date}</div>
                    </div>
                    <div class="text-xs text-[color:var(--color-text-muted)] mt-1">{a.company}{a.region ? ` • ${a.region}` : ''}</div>
                    {a.description && <p class="text-[color:var(--color-text-secondary)] text-xs mt-2 m-0">{a.description}</p>}
                    {a.technologies && a.technologies.length > 0 && (
                      <div class="mt-2 flex flex-wrap gap-2">
                        {a.technologies.map((tech) => (
                          <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-medium" style="background: rgba(var(--accent-rgb),0.08); color: var(--accent); border: 1px solid rgba(var(--accent-rgb),0.15);">
                            {tech}
                          </span>
                        ))}
                      </div>
                    )}
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      )})}
    </div>
  </div>
)}


